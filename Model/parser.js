import zlib from"zlib";function parse(e,t){return new Parser(e,t)}class Parser{constructor(e,t){this.uin=t,this.message=[],this.brief="",this.content="",this.atme=!1,this.atall=!1,this.newImg=!1,this.imgprefix={},this.exclusive=!1;try{Array.isArray(e)?this.parseElems(e):(e[4]&&e[4].length&&this.parseExclusiveElem(0,e[4]),this.parseElems(Array.isArray(e[2])?e[2]:[e[2]]))}catch(e){console.error(e)}}getNextText(){try{var e=this.it?.next().value[1][1];return String(e[1])}catch{return"[未知]"}}parseExclusiveElem(e,t){let i,s;switch(e){case 12:case 51:var r=t[1].toBuffer();i={type:12===e?"xml":"json",data:String(0<r[0]?zlib.unzipSync(r.slice(1)):r.slice(1)),id:t[2]},s=i.type+"消息",this.content=i.data;break;case 3:i=this.parseNewImgElem(t,"flash"),s="闪照",this.content=`{flash:${i.file.slice(0,32).toUpperCase()}}`;break;case 0:i={type:"record",file:"protobuf://"+t.toBase64(),url:"",md5:t[4].toHex(),size:t[6]||0,seconds:t[19]||0},t[20]&&(r=String(t[20]),i.url=r.startsWith("http")?r:"https://grouptalk.c2c.qq.com"+r),s="语音",this.content=`{ptt:${i.url||i.md5}}`;break;case 19:i={type:"video",file:"protobuf://"+t.toBase64(),name:t[3]?.toString()||"",fid:String(t[1]),md5:t[2].toBase64(),size:t[6]||0,seconds:t[5]||0},s="视频",this.content=`{video:${i.fid}}`;break;case 5:r=this.core.pb.decode(t[2].toBuffer().slice(3))[7][2];i={type:"file",name:String(r[4]),fid:String(r[2]).replace("/",""),md5:String(r[8]),size:r[3],duration:r[5]},s="群文件",this.content=`{file:${i.fid}}`;break;case 37:(i={type:"face",id:t[2][3],text:t[2][7]?String(t[2][7]):"超级表情",big:!0}).text||(i.text=t[2][7]?String(t[2][7]):"超级表情"),t[2][2]&&(i.stickerId=String(t[2][2]),i.stickerType=t[2][5]),s=i.text,this.content=`{face:${i.id},text:${i.text}}`;break;case 126:if(!t[3])return;r=126===t[3]?t[2][4]:t[3];i={type:"poke",id:r,text:this.face.pokemap[r]},s=this.face.pokemap[r],this.content=`{poke:${i.id}}`;break;default:return}this.message.push(i),this.brief="["+s+"]"}parsePartialElem(e,t){let i,s="",r="";switch(e){case 1:s=String(t[1]);var a=t[3]?.toBuffer();if(a&&1===a[1])i={type:"at",qq:0,text:s},1===a[6]?(i.qq="all",this.atall=!0):(i.qq=a.readUInt32BE(7),i.qq===this.uin&&(this.atme=!0)),s=s||"@"+i.qq,r=`{at:${i.qq}}`;else{if(!s)return;r=s,i={type:"text",text:s}}break;case 2:i={type:"face",id:t[1],text:this.face.facemap[t[1]]?.text||"表情"},s=`[${i.text}]`,r=`{face:${i.id}}`;break;case 33:i={type:"face",id:t[1],text:t[2]?.toString()||"/"+t[1]},s=`[${i.text}]`,r=`{face:${i.id}}`;break;case 6:s=this.getNextText(),r=s.includes("骰子")||s.includes("猜拳")?`{${(i={type:s.includes("骰子")?"dice":"rps",id:t[12].toBuffer()[16]-48+1}).type}:${i.id}}`:`{bface:${(i={type:"bface",file:t[4].toHex()+t[7].toHex()+t[5],text:s.replace(/[[\]]/g,"")}).text}}`;break;case 4:case 8:if(this.newImg)return;i=this.parseImgElem(e,t,"image"),s=(i.asface?"[动画表情]":"[图片]")+(i.summary||""),r=`{image:${i.md5.toUpperCase()}}`;break;case 31:if(103904510!==t[3])return;i={type:"mirai",data:String(t[2])};break;case 34:s=this.getNextText(),i={type:"sface",id:t[1],text:s.replace(/[[\]]/g,"")},r=`{sface:${i.id}}`;break;case 37:if(2!=t[6])return;i={type:"long_msg",resid:t[7]?.toString()};break;case 45:t=t[2],i={type:"markdown",content:t[1]?.toString(),...t[2]?{config:{unknown:t[2][1]||1,time:t[2][2]||0,token:t[2][3]?.toHex()||""}}:{}},s="[markdown消息]",r=s;break;case 46:t=t[2];try{var c=Array.isArray(t[1][1])?t[1][1]:[t[1][1]];i={type:"button",content:{appid:Number(t[1][2])||0,rows:c.map(e=>{var t,i=[];for(t of e=Array.isArray(e[1])?e[1]:[e[1]]){var s={id:"",render_data:{},action:{permission:{}}};t[1]&&(s.id=t[1]?.toString()),t[2]&&(s.render_data.label=t[2][1]?.toString(),s.render_data.visited_label=t[2][2]?.toString(),s.render_data.style=Number(t[2][3])||0),t[3]&&(s.action.type=Number(t[3][1])||0,s.action.unsupport_tips=t[3][4]?.toString(),s.action.data=t[3][5]?.toString(),s.action.reply=1===t[3][7],s.action.enter=1===t[3][8],t[3][2])&&(s.action.permission.type=Number(t[3][2][1])||0,s.action.permission.specify_role_ids=t[3][2][2]||[],s.action.permission.specify_user_ids=t[3][2][3]||[]),i.push(s)}return{buttons:i}})}},s="[button消息]",r=s}catch{return}break;case 48:switch(t[3]){case 10:case 20:if(!(i=this.parseNewImgElem(t[2],"image")))return;s=(i.asface?"[动画表情]":"[图片]")+(i.summary||""),r=`{image:${i.md5.toUpperCase()}}`;break;case 11:case 21:{let e=t[2][1];var n=(e=Array.isArray(e)?e:[e]).find(e=>100!==e[1][6]);i={type:"video",file:"protobuf://"+t.toBase64(),fid:n[1][2]?.toString(),md5:"ntvideo_"+n[1][1][2]?.toString(),size:n[1][1][1],seconds:n[1][1][8],nt:!0},s="视频",r=`{video:${i.fid}}`;break}case 12:case 22:n=t[2][1][1];i={type:"record",file:"protobuf://"+t.toBase64(),url:"",fid:n[2]?.toString(),md5:n[1][2]?.toString(),size:n[1][1],seconds:n[1][8],nt:!0},s="语音",r=`{ptt:${i.file}}`;break;default:return}break;default:return}2===this.message.length&&"at"===i.type&&"at"===this.message[0]?.type&&"text"===this.message[1]?.type&&this.message[0].qq===i.qq&&" "===this.message[1].text&&(this.message.splice(0,2),this.brief=""),this.brief+=s,this.content+=r,Array.isArray(this.message)||(this.message=[]);var l=this.message[this.message.length-1];"text"===i.type&&"text"===l?.type?l.text+=i.text:this.message.push(i)}parseElems(e){for(this.it=e.entries();;)try{var t=this.it.next().value?.[1];if(!t)break;var i=Number(Object.keys(Reflect.getPrototypeOf(t))[0]),s=t[i];if(16===i)this.extra=s;else if(21===i)this.anon=s;else if(45===i)this.quotation=s;else if(!this.exclusive)switch(i){case 1:case 2:case 4:case 6:case 8:case 31:case 34:case 37:this.parsePartialElem(i,s);break;case 5:case 12:case 19:case 51:this.parseExclusiveElem(i,s);break;case 53:3===s[1]?this.parseExclusiveElem(3,s[2][1]||s[2][2]):33===s[1]?this.parsePartialElem(33,s[2]):2===s[1]?this.parseExclusiveElem(126,s):37===s[1]?this.parseExclusiveElem(37,s):20===s[1]?this.parseExclusiveElem(51,s[2]):[45,46,48,500].includes(s[1])&&this.parsePartialElem(s[1],s)}}catch(e){console.error(e)}}parseNewImgElem(e,t){try{var i={type:t,file:e[1][1][1][4]?.toString(),url:"",fid:e[1][1][2]?.toString(),md5:e[1][1][1][2]?.toString(),height:e[1][1][1][7],width:e[1][1][1][6],size:e[1][1][1][1],summary:e[2][1]?.[2]?.toString(),nt:!0},s=("image"===t&&(i.asface=1===e[2][1]?.[1]),i.file=(0,this.image.buildImageFileParam)(i.md5,i.size,i.width,i.height,e[1][1][1][5][2]),((e[2][1]?.[11]||e[2][1]?.[12])?.[30]||"").toString());if(s?.length)return this.newImg=!0,i.url="https://"+e[1][2][3]+(s.startsWith("/")?s:""+e[1][2][1]+s)+(e[1][2][2][1]||"&spec=0"),i;i.md5&&(i.url="https://"+e[1][2][3]+e[1][2][1],this.imgprefix[i.md5]=i)}catch{if("flash"===t)return this.parseImgElem(0,e,t)}}parseImgElem(e,t,i){let s;var r,e="flash"===i?!!t[1]:8!==e,a=t[e?7:13].toHex(),c=(t[e?29:34]?.[30]||"").toString();return this.imgprefix[a]&&c?.length?(r=this.imgprefix[a].url?.length?new URL(this.imgprefix[a].url).origin:"",s={...this.imgprefix[a],type:i,url:`${c.startsWith("/")?""+r+c:""+this.imgprefix[a].url+c}&spec=0`}):((s={type:i,file:"",url:"",md5:a,height:t[e?8:23],width:t[e?9:22],size:t[e?2:25],summary:t[e?29:34]?.[e?8:9]?.toString()}).file=(0,this.image.buildImageFileParam)(s.md5,s.size,s.width,s.height,t[e?5:20]),"image"===i&&(s.asface=1===t[e?29:34]?.[1]),s.url||(c&&c.includes("fileid")?s.url=`https://c2cpicdw.qpic.cn${c}&spec=0`:t[16]&&String(t[16]).startsWith("/")?s.url="https://gchat.qpic.cn"+t[16]:t[15]&&String(t[15]).startsWith("/")?s.url="https://c2cpicdw.qpic.cn"+t[15]:s.url=`https://gchat.qpic.cn/gchatpic_new/0/0-0-${a.toUpperCase()}/0`),s)}}export{parse,Parser};